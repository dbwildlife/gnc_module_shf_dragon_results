<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Un dragon dans mon jardin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    .wrapper {
      flex: 1;
    }

    .toast {
      z-index: 100000;
    }

    #map {
      width: 100%;
      height: 100%;
      max-height: 100%;
      overflow: hidden;
    }

    .custom-popup .leaflet-popup-content-wrapper {
      background: #2c3e50;
      color: #fff;
      border-radius: 0px;
    }

    .custom-popup .leaflet-popup-content-wrapper a {
      color: rgba(255, 255, 255, 0.1);
    }

    .custom-popup .leaflet-popup-tip-container {
      width: 30px;
      height: 15px;
    }

    .custom-popup .leaflet-popup-tip {
      background: transparent;
      border: none;
      box-shadow: none;
    }
  </style>
</head>

<body class="d-flex flex-column vh-100">
  <!-- <div id="header" class="container-fluid">
    <div class="row">
      <div class="col col-lg-12">
        <div class="mb-3">
          <label for="taxaSelect" class="form-label">Espèce ou groupe d'espèce</label>
          <select class="form-select" aria-label="taxaSelect">
            <option selected>Open this select menu</option>
            <option value="1">One</option>
            <option value="2">Two</option>
            <option value="3">Three</option>
          </select>
        </div>
      </div>
    </div>
  </div> -->

  <div class="d-flex h-100">
    <div class="container-fluid d-flex flex-column">
      <div class="row d-flex h-100">
        <div class="col-4 d-flex flex-column overflow-y h-100">
          <div>

            <canvas id="chartJsBarChart" width="500px" height="300px" aria-label="bar Chart" role="img"></canvas>
          </div>
          <div id='taxaList' class="list-group h-100 overflow-auto" style="max-height: 100% !important;"></div>
        </div>
        <div class="col-8 px-0 align-items-stretch">
          <div id="map" class="custom-popup h-100">map</div>
        </div>
      </div>
    </div>
  </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://d3js.org/d3.v6.js"></script>

<script>
  // declare common variables
  let map;
  let cd_nom;
  let areas;
  let taxaList;

  const removeEmpty = (obj) => {
    return Object.fromEntries(Object.entries(obj).filter(([_, v]) => v != null));
  }
  const initTaxaList = async () => {
    const taxonDetailsUrl = 'https://gncitizen.demo.targezed.net/api/taxonomy/lists/1264/species'
    const taxonDetailsResponse = await fetch(taxonDetailsUrl)
    taxaList = await taxonDetailsResponse.json()
  }
  const initMap = () => {
    map = L.map('map').setView([48.84435, 2.35588], 18)
    //tileLayerUrl='https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.{ext}'
    const tileLayerUrl = '//a.tile.openstreetmap.fr/hot/{z}/{x}/{y}{r}.{ext}'
    L.tileLayer(tileLayerUrl, {
      minZoom: 0,
      maxZoom: 20,
      attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      ext: 'png'
    }).addTo(map)
  }

  const loadMapData = (cd_nom) => {
    const getColor = (d) => {
      return d > 100 ? '#800026' : d > 50 ? '#BD0026' : d > 20 ? '#E31A1C' : d > 10 ? '#FC4E2A' : d > 5 ? '#FD8D3C' : d > 2 ? '#FEB24C' : d > 1 ? '#FED976' : '#FFEDA0'
    }
    const style = (feature) => {
      return {
        fillColor: getColor(feature.properties.count_occtax),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
      }
    }
    const highlightFeature = (e) => {
      var layer = e.target

      layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
      })

      layer.bringToFront()
    }
    const resetHighlight = (e) => {
      layer.resetStyle()
      info.update()
    }
    const zoomToFeature = (e) => {
      map.fitBounds(e.target.getBounds())
    }

    const onEachFeature = (feature, layer) => {
      // layer.on({
      //     mouseover: highlightFeature,
      //     mouseout: resetHighlight,
      //     click: zoomToFeature
      // })
      //const popupContent = `feature.properties.count`
      layer.bindPopup(
        `<h5>${feature.properties.area_name}</h5>
          <p>
            <dl>
                <dt>Nombre de taxons</dt>
                <dd>${feature.properties.count_taxa} taxons</dd>

                <dt>Nombre de données</dt>
                <dd>${feature.properties.count_occtax} observations</dd>
              </dl>
                                                                                  </ul>
          </p>`
      )
    }

    const getData = async () => {
      const params = new URLSearchParams(removeEmpty({ cd_nom: cd_nom, id_type: 34 }))
      const url = '/api/results/synthesis/map?' + params
      const response = await fetch(url)
      const geojsonFeature = await response.json()
      if (areas) {
        map.removeLayer(areas)
      }
      areas = L.geoJSON(geojsonFeature, { style: style, onEachFeature: onEachFeature })
      map.addLayer(areas)
      map.fitBounds(areas.getBounds())
    }
    getData()
  }

  // // START D3 CHART
  // const d3jsBarChart = (cd_nom) => {
  //   // set the dimensions and margins of the graph
  //   const margin = { top: 10, right: 30, bottom: 90, left: 40 },
  //     width = 460 - margin.left - margin.right,
  //     height = 450 - margin.top - margin.bottom

  //   // append the svg object to the body of the page
  //   const svg = d3
  //     .select('#my_dataviz')
  //     .append('svg')
  //     .attr('width', width + margin.left + margin.right)
  //     .attr('height', height + margin.top + margin.bottom)
  //     .append('g')
  //     .attr('transform', `translate(${margin.left},${margin.top})`)

  //   // Parse the Data
  //   d3.json('/api/results/synthesis/chart').then(function (data) {
  //     // X axis
  //     const x = d3
  //       .scaleBand()
  //       .range([0, width])
  //       .domain(data.map((d) => d.label))
  //       .padding(0.2)
  //     svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x)).selectAll('text').attr('transform', 'translate(-10,0)rotate(-45)').style('text-anchor', 'end')

  //     // Add Y axis
  //     const y = d3
  //       .scaleLinear()
  //       .domain([0, d3.max(data.map((i) => i.count_occtax)) * 1.1])
  //       .range([height, 0])
  //     svg.append('g').call(d3.axisLeft(y))

  //     // Bars
  //     svg
  //       .selectAll('mybar')
  //       .data(data)
  //       .join('rect')
  //       .attr('x', (d) => x(d.label))
  //       .attr('width', x.bandwidth())
  //       .attr('fill', '#69b3a2')
  //       // no bar at the beginning thus:
  //       .attr('height', (d) => height - y(0)) // always equal to 0
  //       .attr('y', (d) => y(0))

  //     // Animation
  //     svg
  //       .selectAll('rect')
  //       .transition()
  //       .duration(800)
  //       .attr('y', (d) => y(d.count_occtax))
  //       .attr('height', (d) => height - y(d.count_occtax))
  //       .delay((d, i) => {
  //         return i * 100
  //       })
  //   })
  // }

  const chartJsBarChart = (cd_nom) => {
    const config = (items) => {
      return {
        type: 'bar',
        data: {
          labels: items.map((i) => i.label),
          datasets: [{
            label: 'Répartition annuelle des données',
            data: items.map((i) => i.count_occtax)
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      }
    }
    const getData = async () => {
      const params = new URLSearchParams(removeEmpty({ cd_nom: cd_nom }))
      const url = '/api/results/synthesis/chart?' + params
      const response = await fetch(url)
      const jsonResp = await response.json()
      const tmpChart = Chart.getChart('chartJsBarChart');
      if (tmpChart) {
        tmpChart.destroy()
      }
      new Chart(document.getElementById('chartJsBarChart'), config(jsonResp))
    }

    getData()
  }

  const genList = async () => {
    const div = document.getElementById('taxaList')
    // const params = new URLSearchParams(removeEmpty({ cd_nom: cd_nom }))
    const url = '/api/results/synthesis/list'

    const response = await fetch(url)
    const jsonResp = await response.json()

    const a = document.createElement('a')
    jsonResp.forEach(i => {
      const taxon = taxaList.filter(e => e.cd_nom == i.cd_nom)[0]
      const a = document.createElement('a')
      a.setAttribute('class', 'list-group-item list-group-item-action flex-column align-items-start');
      a.setAttribute('href', '#');
      a.setAttribute('data-id', taxon.cd_nom)
      a.setAttribute('onclick', 'filterData(this);')

      a.innerHTML = `
        <div class="d-flex">
  <div class="flex-shrink-0">
    <img class="img-thumbnail" src="https://geonature.demo.dbwildlife.info/taxhub/api/tmedias/thumbnail/${taxon.medias[0]?.id_media}?h=80" width="80" height="80" alt="photo" loading="lazy" >
  </div>
  <div class="flex-grow-1 ms-3">
    <h5 class="mb-1">${taxon.nom_francais}</h5>
            <small>${taxon.taxref.lb_nom}</small>
            <p class="mb-1">Espèce observée <strong>${i.count_occtax}</strong> fois</p>
            <small>Dernière observation le ${i.last_data}</small>
  </div>
</div>
        `;
      div.appendChild(a);
    })

  }

  const genData = (cd_nom) => {

    chartJsBarChart(cd_nom)
    loadMapData(cd_nom)
  }

  function filterData(d) {
    document.querySelectorAll(`[data-id]`)?.forEach(element => element.classList.remove("active"))
    if (d.getAttribute("data-id") === cd_nom) {
      cd_nom = null;
    } else {
      cd_nom = d.getAttribute("data-id")
      d.classList.add('active')
    }

    genData(cd_nom);
  }

  document.addEventListener('DOMContentLoaded', () => {
    initMap()
    initTaxaList().then(() => {
      genList()
      genData(null)
    })

  })

  // END D3 CHART
</script>


</html>